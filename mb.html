<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>IMAT Practice â€” Chemistry & Biology</title>
<style>
  :root{
    --bg:#f5f5f7; --fg:#1d1d1f; --card:#fff; --muted:#666; --accent:#0a84ff;
    --ok:#0a0; --bad:#d00; --shadow:0 6px 18px rgba(0,0,0,0.08);
  }
  html,body{height:100%}
  body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,sans-serif;background:var(--bg);color:var(--fg);margin:0;padding:16px;transition:background .25s,color .25s}
  h1{font-size:1.6rem;margin:0 0 12px;}
  h2{font-size:1.2rem;margin:0 0 10px;}
  .muted{color:var(--muted);}
  .small{font-size:.9rem;}
  .screen{display:none;opacity:0;transform:translateY(6px);transition:opacity .28s, transform .28s;}
  .screen.active{display:block;opacity:1;transform:none;}
  .card{background:var(--card);border-radius:14px;padding:12px;box-shadow:var(--shadow);transition:transform .18s, box-shadow .18s;}
  .card:hover{transform:translateY(-4px);box-shadow:0 10px 30px rgba(0,0,0,0.08)}
  fieldset{background:var(--card);border:none;border-radius:12px;padding:12px;margin:10px 0;box-shadow:var(--shadow);}
  legend{font-weight:700;}
  label{display:block;padding:8px;border-radius:8px;cursor:pointer;transition:background .14s, transform .12s;}
  label:hover{background:#f0f0f5; color:#000; transform:translateX(3px);} /* testo nero su hover */
  input[type="radio"]{margin-right:8px;}
  .topbar{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;}
  .row{display:flex;gap:8px;flex-wrap:wrap;}
  button{background:#000;color:#fff;border:none;border-radius:10px;padding:12px 14px;font-size:1rem;cursor:pointer;transition:transform .12s,opacity .12s}
  button:active{transform:translateY(2px)}
  button.secondary{background:#fff;color:#000;border:1px solid #ccc}
  .progress{height:10px;background:#e9e9ed;border-radius:10px;overflow:hidden;margin:8px 0;}
  .progress>i{display:block;height:100%;background:var(--accent);width:0%;transition:width .4s ease}
  .pill{display:inline-block;padding:6px 10px;border-radius:999px;background:#fff;box-shadow:0 2px 6px rgba(0,0,0,.06);margin-right:8px;color:#000;}
  .site-message{position:fixed;left:50%;transform:translateX(-50%);bottom:18px;z-index:9999;max-width:92%;}
  .notice{background:#fff;border-radius:12px;padding:12px;box-shadow:0 6px 18px rgba(0,0,0,.12);display:flex;gap:8px;align-items:center;justify-content:space-between;}
  .correct{color:var(--ok);} .incorrect{color:var(--bad);}
  .year{color:#777;font-size:.85rem;margin:.25rem 0 .1rem;}
  .subjectTitle{font-size:.95rem;color:#fff;margin-bottom:6px;font-weight:700;}
  @media (max-width:680px){ body{padding:12px} button{padding:10px 12px;font-size:.95rem} }

  /* Dark */
  body.dark{--bg:#0b0b0c;--fg:#e6e6e8;--card:#161617;--muted:#a1a1a6;--accent:#0a84ff;--shadow:0 6px 18px rgba(0,0,0,0.25)}

  /* Progress bar bottom */
  .quiz-progress-bar {
    position: fixed;
    left: 50%;
    bottom: 18px;
    transform: translateX(-50%);
    z-index: 10000;
    background: var(--card);
    box-shadow: var(--shadow);
    border-radius: 14px;
    padding: 12px 24px 16px 24px;
    min-width: 220px;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 7px;
    transition: opacity 0.2s;
  }
  .quiz-progress-bar[hidden] { display: none !important; }
  .quiz-progress-bar .progress { width: 220px; margin: 0 0 2px 0; }
  .quiz-progress-bar .quiz-timer { font-size: 1.05rem; color: var(--muted); margin: 0; text-align: center; }
  @media (max-width: 480px) {
    .quiz-progress-bar { min-width: 0; width: 96vw; padding: 10px 2vw 12px 2vw; }
    .quiz-progress-bar .progress { width: 100%; }
  }

  /* Question transition */
  .question-wrap{position:relative;min-height:120px;}
  .question-card{transition:opacity .28s, transform .28s;opacity:0;transform:translateY(6px)}
  .question-card.visible{opacity:1;transform:none}

  /* small helpers */
  .muted-inline{color:var(--muted);font-size:.9rem}
  .center{text-align:center}
</style>
</head>
<body>
<!-- Site message / toast -->
<div id="siteMessage" class="site-message" style="display:none;" aria-live="polite">
  <div class="notice"><div id="siteMessageText"></div><div id="siteMessageBtns"></div></div>
</div>

<!-- Barra di avanzamento quiz in basso -->
<div id="quizProgressBar" class="quiz-progress-bar" hidden>
  <div class="progress"><i id="progBar" style="width:0%"></i></div>
  <div class="quiz-timer" id="quizTimer">Tempo: 0:00</div>
</div>

<!-- LOGIN -->
<div id="login" class="screen active">
  <div class="card">
    <h1>IMAT Practice â€” Login</h1>
    <p class="muted small">Inserisci la passkey per accedere.</p>
    <input id="passkey" type="password" placeholder="Passkey (0000)" style="width:100%;padding:12px;border-radius:10px;border:1px solid #c7c7cc;font-size:1rem;margin:8px 0"/>
    <button id="loginBtn" style="width:100%;">Entra</button>
    <p class="muted small" style="margin-top:8px;">Codice pubblico: 0000 (Guest)</p>
    <p class="muted small" id="localServeNotice" style="margin-top:8px;display:none;color:#a33">Se apri il file localmente su iPhone potresti dover servire i file via HTTP (vedi istruzioni).</p>
  </div>
</div>

<!-- HOME -->
<div id="home" class="screen">
  <div class="topbar">
    <h1 id="welcomeTitle">IMAT Practice</h1>
    <div class="row">
      <button class="secondary" id="toggleThemeBtn" title="Tema">ðŸŒ™</button>
      <button class="secondary" id="logoutBtn">Logout</button>
    </div>
  </div>

  <div class="card" style="margin-bottom:10px;">
    <div class="subjectTitle" style="background:linear-gradient(90deg,#0a84ff,#0066ff);padding:8px;border-radius:8px;">Chimica</div>
    <div class="row" style="gap:10px;margin-top:8px;">
      <button id="startChemBtn" style="flex:1">Start Chemistry Quiz</button>
      <button id="chemTrainingBtn" class="secondary">Training Mode (Chemistry)</button>
      <button id="historyChemBtn" class="secondary">History Chimica</button>
    </div>
  </div>

  <div class="card">
    <div class="subjectTitle" style="background:linear-gradient(90deg,#37b24d,#2fa44f);padding:8px;border-radius:8px;">Biologia</div>
    <div class="row" style="gap:10px;margin-top:8px;">
      <button id="startBioBtn" style="flex:1">Start Biology Quiz</button>
      <button id="bioTrainingBtn" class="secondary">Training Mode (Biology)</button>
      <button id="historyBioBtn" class="secondary">History Biologia</button>
    </div>
  </div>
</div>

<!-- QUIZ -->
<div id="quiz" class="screen">
  <div class="topbar">
    <h1 id="quizTitle">Quiz</h1>
    <div class="row">
      <span class="pill" id="qCountPill">Q 0/0</span>
      <button class="secondary" id="quitQuizBtn">Esci</button>
    </div>
  </div>
  <div id="quizContent" class="card question-wrap">
    <!-- question inserted by JS -->
  </div>

  <div style="margin-top:8px" class="row">
    <button id="prevBtn" class="secondary">Indietro</button>
    <button id="nextBtn">Prossima</button>
  </div>
</div>

<!-- REVIEW -->
<div id="review" class="screen">
  <div class="card">
    <h1>Review</h1>
    <div id="reviewContent"></div>
    <div style="margin-top:10px" class="row">
      <button id="toResultBtn">Vai al risultato</button>
      <button id="backHomeFromReview" class="secondary">Home</button>
    </div>
  </div>
</div>

<!-- RESULT -->
<div id="result" class="screen">
  <div class="card">
    <h1>Risultato</h1>
    <div id="resultContent"></div>
    <div style="margin-top:10px" class="row">
      <button id="resultHomeBtn">Home</button>
      <button id="retryBtn" class="secondary">Riprova</button>
    </div>
  </div>
</div>

<!-- HISTORY -->
<div id="history" class="screen">
  <div class="card">
    <h1>History</h1>
    <div id="historyContent"></div>
    <div style="margin-top:10px" class="row">
      <button id="historyHomeBtn">Home</button>
      <button id="clearHistoryBtn" class="secondary">Cancella storia</button>
    </div>
  </div>
</div>

<!-- TRAINING -->
<div id="training" class="screen">
  <div class="card">
    <h1>Training</h1>
    <div id="trainingContent"></div>
    <div style="margin-top:10px" class="row">
      <button id="trainingHomeBtn">Home</button>
    </div>
  </div>
</div>

<script>
/* =================== CONFIG =================== */
/* file paths for external JSONs (must be in same folder) */
const CHEM_JSON = './chemistry-questions.json';
const BIO_JSON  = './biology-questions.json';

/* =================== DATA LOADERS =================== */
/* chemistry and biology loads similar pattern */
var chemistryQuestions = null, chemistryLoaded=false, chemistryLoading=false, chemistryLoadCbs=[];
var biologyQuestions  = null,  biologyLoaded=false,  biologyLoading=false,  biologyLoadCbs=[];

function loadChemistryQuestions(cb){
  if(chemistryLoaded){ cb && cb(null); return; }
  chemistryLoadCbs.push(cb);
  if(chemistryLoading) return;
  chemistryLoading = true;
  fetch(CHEM_JSON)
    .then(r => {
      if(!r.ok) throw new Error('HTTP error '+r.status);
      return r.json();
    })
    .then(data=>{
      chemistryQuestions = data;
      chemistryLoaded = true; chemistryLoading = false;
      chemistryLoadCbs.forEach(f=>f && f(null)); chemistryLoadCbs=[];
    })
    .catch(err=>{
      chemistryLoading=false;
      chemistryLoadCbs.forEach(f=>f && f(err)); chemistryLoadCbs=[];
      showMsg('Errore caricamento chimica: '+(err && err.message?err.message:''), [{label:'OK', secondary:true}]);
    });
}

function loadBiologyQuestions(cb){
  if(biologyLoaded){ cb && cb(null); return; }
  biologyLoadCbs.push(cb);
  if(biologyLoading) return;
  biologyLoading = true;
  fetch(BIO_JSON)
    .then(r => {
      if(!r.ok) throw new Error('HTTP error '+r.status);
      return r.json();
    })
    .then(data=>{
      biologyQuestions = data;
      biologyLoaded = true; biologyLoading=false;
      biologyLoadCbs.forEach(f=>f && f(null)); biologyLoadCbs=[];
    })
    .catch(err=>{
      biologyLoading=false;
      biologyLoadCbs.forEach(f=>f && f(err)); biologyLoadCbs=[];
      showMsg('Errore caricamento biologia: '+(err && err.message?err.message:''), [{label:'OK', secondary:true}]);
    });
}

/* =================== STATIC / INLINE fallback removed (we now fetch) =================== */

/* ===== Users + state ===== */
var users = {
  "0000": "Guest",
  "2010": "Chiara",
  "2111": "Ale",
  "2405": "Tony"
};
var currentUser = null;

/* active subject/pool used by quiz/training generic routines */
var activeSubject = null; // 'Chemistry' or 'Biology'
var activePool = null;    // pointer to array of questions currently active
var shuffledQuestions = [];
var RECENT_CACHE_SIZE = 30;
var lastAskedPerUser = {}; // { userKey: [ "Chemistry::Qtext", ... ] }

/* ===== Local storage helpers (unchanged behavior) ===== */
function lsGet(key, def){ try{ var v = localStorage.getItem(key); return v? JSON.parse(v): def; }catch(e){ return def; } }
function lsSet(key, val){ try{ localStorage.setItem(key, JSON.stringify(val)); }catch(e){} }

/* ========== QUESTION STATS (scoped per subject) ========== */
function _qKey(subject, question){ return (subject||'Unknown') + '::' + question; }
function loadQStats(){ return lsGet('imat_qstats', {}); }
function saveQStats(o){ lsSet('imat_qstats', o); }
function incQAsked(subject, q){ var s=loadQStats(); var k=_qKey(subject,q); s[k]=s[k]||{asked:0,wrong:0}; s[k].asked++; saveQStats(s); }
function incQWrong(subject, q){ var s=loadQStats(); var k=_qKey(subject,q); s[k]=s[k]||{asked:0,wrong:0}; s[k].wrong++; saveQStats(s); }
function resetQWrong(subject, q){ var s=loadQStats(); var k=_qKey(subject,q); if(s[k]){ s[k].wrong=0; saveQStats(s);} }
function getQStatsFor(subject, q){ var s=loadQStats(); var k=_qKey(subject,q); return s[k]||{asked:0,wrong:0}; }

/* =================== UI helpers =================== */
function showScreen(id){
  document.querySelectorAll('.screen').forEach(function(s){ s.classList.remove('active'); });
  var el = document.getElementById(id); if(el) el.classList.add('active');
  if(id==='history') renderHistory();
  var bar = document.getElementById('quizProgressBar');
  if(bar) bar.hidden = (id !== 'quiz');
}
function showMsg(text, buttons){
  var wrap=document.getElementById('siteMessage');
  document.getElementById('siteMessageText').innerHTML = text;
  var b = document.getElementById('siteMessageBtns'); b.innerHTML='';
  (buttons||[]).forEach(function(btn){
    var el=document.createElement('button');
    el.textContent = btn.label; el.className = btn.secondary? 'secondary':''; el.style.marginLeft='6px';
    el.onclick = function(){ wrap.style.display='none'; btn.onClick && btn.onClick(); };
    b.appendChild(el);
  });
  wrap.style.display='block';
  // auto hide after 6s if no buttons
  if(!(buttons && buttons.length)) setTimeout(function(){ wrap.style.display='none'; },6000);
}

/* =================== LOGIN / LOGOUT =================== */
function login(){
  var key = (document.getElementById('passkey').value||'').trim();
  if(users[key]){
    currentUser = key;
    document.getElementById('welcomeTitle').textContent = 'IMAT Practice â€” '+users[key];
    showScreen('home');
  }else{
    showMsg('Passkey non valida.', [{label:'OK', secondary:true}]);
  }
}
function logout(){ currentUser=null; document.getElementById('passkey').value=''; showScreen('login'); }

/* =================== UTILS =================== */
function shuffleArray(arr){ var a=arr.slice(); for(var i=a.length-1;i>0;i--){ var j=Math.floor(Math.random()*(i+1)); var t=a[i]; a[i]=a[j]; a[j]=t; } return a; }

/* pickQuestions accepts pool and subject */
function pickQuestions(pool, n){
  var poolCopy = pool.slice();
  var recent = lastAskedPerUser[currentUser]||[];
  var available = poolCopy.filter(function(q){ return recent.indexOf(activeSubject + '::' + q.question) === -1; });
  if(available.length < n) available = poolCopy.slice();
  return shuffleArray(available).slice(0,n);
}

/* =================== GENERIC QUIZ =================== */
var quizStartTime=null, quizTimerInterval=null;
var quizElapsedSeconds=0;
var quizQuestions = [];
var quizAnswers = []; // user answers index
var quizCurrentIndex = 0;
var QUIZ_TOTAL = 20; // default number of questions

function startStopwatch(){
  quizStartTime = Date.now();
  var el = document.getElementById('quizTimer');
  function upd(){
    quizElapsedSeconds = Math.floor((Date.now()-quizStartTime)/1000);
    var mm = Math.floor(quizElapsedSeconds/60);
    var ss = quizElapsedSeconds%60;
    el.textContent = 'Tempo: '+mm+':'+(ss<10?'0'+ss:ss);
  }
  clearInterval(quizTimerInterval);
  upd();
  quizTimerInterval = setInterval(upd,1000);
}
function stopStopwatch(){ clearInterval(quizTimerInterval); quizTimerInterval=null; }

/* Start quiz for a subject - ensures questions are loaded */
function startQuizFor(subject, trainingMode){
  activeSubject = subject;
  document.getElementById('quizTitle').textContent = subject + (trainingMode? ' â€” Training' : '');
  // Load JSON if needed
  var loader = (subject==='Chemistry')? loadChemistryQuestions : loadBiologyQuestions;
  loader(function(err){
    if(err){
      // If fetch failed likely due to local file protocol
      document.getElementById('localServeNotice').style.display='block';
      showMsg('Impossibile caricare le domande. Assicurati di servire i file tramite HTTP (es. GitHub Pages o python -m http.server).', [{label:'OK', secondary:true}]);
      return;
    }
    // set active pool
    activePool = (subject==='Chemistry')? chemistryQuestions : biologyQuestions;
    if(!activePool || !activePool.length){
      showMsg('Nessuna domanda trovata per '+subject, [{label:'OK', secondary:true}]);
      return;
    }
    // choose questions
    QUIZ_TOTAL = Math.min( (trainingMode? 30 : 20), activePool.length );
    quizQuestions = pickQuestions(activePool, QUIZ_TOTAL);
    quizAnswers = new Array(quizQuestions.length).fill(null);
    quizCurrentIndex = 0;
    // add to lastAskedPerUser
    lastAskedPerUser[currentUser] = lastAskedPerUser[currentUser] || [];
    quizQuestions.forEach(q => {
      lastAskedPerUser[currentUser].push(activeSubject + '::' + q.question);
      if(lastAskedPerUser[currentUser].length>RECENT_CACHE_SIZE) lastAskedPerUser[currentUser].shift();
    });
    // UI init
    document.getElementById('qCountPill').textContent = 'Q 1/'+quizQuestions.length;
    showScreen('quiz');
    renderQuestion(quizCurrentIndex);
    startStopwatch();
  });
}

/* render a single question by index */
function renderQuestion(index){
  var container = document.getElementById('quizContent');
  container.innerHTML = ''; // replace
  var q = quizQuestions[index];
  if(!q){ container.innerHTML = '<div class="card">Errore domanda</div>'; return; }

  var card = document.createElement('div'); card.className='question-card card';
  // header
  var hdr = document.createElement('div'); hdr.style.marginBottom='8px';
  var yr = document.createElement('div'); yr.className='year muted small'; yr.textContent = q.year || '';
  var qtitle = document.createElement('h2'); qtitle.style.margin='6px 0'; qtitle.textContent = q.question || '';
  hdr.appendChild(yr); hdr.appendChild(qtitle);
  card.appendChild(hdr);

  // options
  var fs = document.createElement('fieldset');
  var legend = document.createElement('legend'); legend.textContent = 'Seleziona la risposta';
  fs.appendChild(legend);
  q.options.forEach(function(opt, i){
    var id = 'opt_'+index+'_'+i;
    var lbl = document.createElement('label'); lbl.htmlFor=id;
    var radio = document.createElement('input'); radio.type='radio'; radio.name='opt_'+index; radio.id=id; radio.value=i;
    if(quizAnswers[index] === i) radio.checked = true;
    radio.onchange = function(){
      quizAnswers[index] = i;
      // store attempt stats
    };
    lbl.appendChild(radio);
    var span = document.createElement('span'); span.textContent = opt;
    lbl.appendChild(span);
    fs.appendChild(lbl);
  });
  card.appendChild(fs);

  // explanation area (hidden until needed or in training mode show)
  var expl = document.createElement('div'); expl.style.marginTop='10px'; expl.id='explain_'+index;
  expl.innerHTML = '<div class="muted small">Spiegazione: <div style="margin-top:6px">'+(q.explanation||'')+'</div></div>';
  expl.style.display = 'none';
  card.appendChild(expl);

  // footer with source and show explanation
  var footer = document.createElement('div'); footer.style.marginTop='8px'; footer.className='muted small';
  footer.innerHTML = 'Fonte: '+(q.source || 'â€”');
  var showBtn = document.createElement('button'); showBtn.className='secondary'; showBtn.textContent='Mostra spiegazione';
  showBtn.style.marginLeft='8px'; showBtn.onclick = function(){
    expl.style.display = (expl.style.display==='none')? 'block':'none';
  };
  footer.appendChild(showBtn);
  card.appendChild(footer);

  // animate in
  container.appendChild(card);
  // small delay to trigger CSS transition
  setTimeout(function(){ card.classList.add('visible'); },20);

  // update pills
  document.getElementById('qCountPill').textContent = 'Q '+(index+1)+'/'+quizQuestions.length;
  // update progress bar
  var prog = Math.round(((index)/quizQuestions.length)*100);
  document.getElementById('progBar').style.width = prog+'%';
}

/* next / prev */
function goNext(){
  if(quizCurrentIndex < quizQuestions.length-1){
    quizCurrentIndex++;
    renderQuestion(quizCurrentIndex);
  }else{
    // end -> review/results
    showReview();
  }
}
function goPrev(){
  if(quizCurrentIndex>0){ quizCurrentIndex--; renderQuestion(quizCurrentIndex); }
}

/* show review */
function showReview(){
  stopStopwatch();
  // compute some numbers
  var resDiv = document.getElementById('reviewContent'); resDiv.innerHTML = '';
  quizQuestions.forEach(function(q,i){
    var div = document.createElement('div'); div.className='card'; div.style.marginBottom='8px';
    var title = document.createElement('div'); title.innerHTML = '<strong>Q'+(i+1)+'.</strong> '+q.question;
    var userAns = quizAnswers[i];
    var userText = (userAns===null)? '<em>Non risposta</em>' : q.options[userAns];
    var correctText = q.options[q.correct];
    var status = (userAns===q.correct)? '<span class="correct">Corretto</span>' : '<span class="incorrect">Sbagliato</span>';
    div.innerHTML = '<div style="margin-bottom:6px">'+title.innerHTML+'</div><div>La tua risposta: '+userText+' â€” '+status+'</div><div style="margin-top:6px"><em>Spiegazione:</em> '+(q.explanation||'')+'</div>';
    resDiv.appendChild(div);
  });
  showScreen('review');
}

/* show results */
function showResults(){
  var correct = 0;
  quizQuestions.forEach(function(q,i){
    if(quizAnswers[i] === q.correct) correct++;
    incQAsked(activeSubject, q.question);
    if(quizAnswers[i] !== q.correct) incQWrong(activeSubject, q.question);
  });
  var resEl = document.getElementById('resultContent');
  var pct = Math.round((correct/quizQuestions.length)*100);
  resEl.innerHTML = '<div style="font-size:1.6rem;font-weight:700">'+correct+'/'+quizQuestions.length+' â€” '+pct+'%</div>';
  resEl.innerHTML += '<div class="muted small" style="margin-top:6px">Tempo impiegato: '+Math.floor(quizElapsedSeconds/60)+':'+(quizElapsedSeconds%60<10?'0'+(quizElapsedSeconds%60):quizElapsedSeconds%60)+'</div>';
  showScreen('result');
}

/* render history simple */
function renderHistory(){
  var root = document.getElementById('historyContent'); root.innerHTML = '';
  var stats = loadQStats();
  var rows = [];
  for(var k in stats){
    rows.push({q:k,asked:stats[k].asked,wrong:stats[k].wrong});
  }
  if(rows.length===0){ root.innerHTML = '<div class="muted">Nessuna attivitÃ  registrata</div>'; return; }
  rows.sort(function(a,b){ return (b.asked - a.asked); });
  rows.slice(0,200).forEach(function(r){
    var div = document.createElement('div'); div.className='card'; div.style.marginBottom='8px';
    div.innerHTML = '<div style="font-size:.95rem"><strong>'+r.q+'</strong></div><div class="muted small">Asked: '+r.asked+' â€” Wrong: '+r.wrong+'</div>';
    root.appendChild(div);
  });
}

/* clear history */
function clearHistory(){ localStorage.removeItem('imat_qstats'); renderHistory(); showMsg('Storico cancellato.', [{label:'OK', secondary:true}]); }

/* =================== DOM bindings =================== */
document.getElementById('loginBtn').addEventListener('click', login);
document.getElementById('logoutBtn').addEventListener('click', logout);
document.getElementById('toggleThemeBtn').addEventListener('click', function(){
  document.body.classList.toggle('dark');
});
document.getElementById('startChemBtn').addEventListener('click', function(){ startQuizFor('Chemistry', false); });
document.getElementById('chemTrainingBtn').addEventListener('click', function(){ startQuizFor('Chemistry', true); });
document.getElementById('startBioBtn').addEventListener('click', function(){ startQuizFor('Biology', false); });
document.getElementById('bioTrainingBtn').addEventListener('click', function(){ startQuizFor('Biology', true); });
document.getElementById('historyChemBtn').addEventListener('click', function(){ showScreen('history'); });
document.getElementById('historyBioBtn').addEventListener('click', function(){ showScreen('history'); });

document.getElementById('prevBtn').addEventListener('click', goPrev);
document.getElementById('nextBtn').addEventListener('click', function(){
  // if last question: go to results confirmation
  if(quizCurrentIndex === quizQuestions.length-1){
    // force compute results
    showResults();
  } else {
    goNext();
  }
});
document.getElementById('quitQuizBtn').addEventListener('click', function(){ stopStopwatch(); showScreen('home'); });

document.getElementById('toResultBtn').addEventListener('click', showResults);
document.getElementById('backHomeFromReview').addEventListener('click', function(){ showScreen('home'); });
document.getElementById('resultHomeBtn').addEventListener('click', function(){ showScreen('home'); });
document.getElementById('retryBtn').addEventListener('click', function(){ startQuizFor(activeSubject,false); });

document.getElementById('historyHomeBtn').addEventListener('click', function(){ showScreen('home'); });
document.getElementById('clearHistoryBtn').addEventListener('click', clearHistory);

document.getElementById('trainingHomeBtn').addEventListener('click', function(){ showScreen('home'); });

/* keyboard convenience */
document.addEventListener('keydown', function(e){
  if(document.querySelector('.screen.active').id === 'quiz'){
    if(e.key === 'ArrowRight') goNext();
    if(e.key === 'ArrowLeft') goPrev();
  }
});

/* =================== On load checks =================== */
window.addEventListener('load', function(){
  // detect if running via file:// and fetch may fail -> show small note in login
  if(location.protocol === 'file:'){
    document.getElementById('localServeNotice').style.display='block';
  }
  // try prefetching both JSONs (non-blocking)
  loadChemistryQuestions(function(err){ if(err) console.warn('Chem load err',err); });
  loadBiologyQuestions(function(err){ if(err) console.warn('Bio load err',err); });
});

/* small helper show message */
function showMsg(t, btns){ showMsg = showMsg; /* placeholder in case used earlier */ showMsgInner(t, btns); }
function showMsgInner(text, buttons){ showMsgInner = function(t,b){ return showMsgInternal(t,b); }; return showMsgInternal(text, buttons); }
function showMsgInternal(text, buttons){ var wrap=document.getElementById('siteMessage'); document.getElementById('siteMessageText').innerHTML = text; var b=document.getElementById('siteMessageBtns'); b.innerHTML=''; (buttons||[]).forEach(function(btn){ var el=document.createElement('button'); el.textContent=btn.label; el.className=btn.secondary? 'secondary':''; el.onclick=function(){ wrap.style.display='none'; btn.onClick && btn.onClick(); }; b.appendChild(el); }); wrap.style.display='block'; if(!(buttons && buttons.length)) setTimeout(function(){ wrap.style.display='none'; },6000); }

/* Expose small function to check loaded state (for debugging) */
window._debug = {
  chemistryLoaded: function(){ return chemistryLoaded; },
  biologyLoaded: function(){ return biologyLoaded; }
};
</script>
</body>
</html>
